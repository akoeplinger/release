#!/bin/sh

# Some things we'll need to run as root
EXEC_AS_ROOT='sudo'

$EXEC_AS_ROOT mount /proc &> /dev/null

version=$1
rev=$2
build_location=$3
rm -rf $build_location/builder/built-packages 		|| exit 1
# Make sure it exists...
mkdir -p $build_location				|| exit 1
cd $build_location && rm -rf scratch		 	|| exit 1
mkdir scratch && cd scratch 				|| exit 1

# These need sudo because the uids of builder of the host and jail may not match up
$EXEC_AS_ROOT mv ../ximian-build.conf . 2> /dev/null
$EXEC_AS_ROOT mv ../*.patch .           2> /dev/null
$EXEC_AS_ROOT mv ../*.tar.gz .          2> /dev/null
$EXEC_AS_ROOT mv ../*.tar.bz2 .         2> /dev/null
$EXEC_AS_ROOT mv ../*.zip .             2> /dev/null

# rpm needs this to be happy
$EXEC_AS_ROOT chown root:root *.tar.gz  2> /dev/null
$EXEC_AS_ROOT chown root:root *.tar.bz2 2> /dev/null
$EXEC_AS_ROOT chown root:root *.zip     2> /dev/null
$EXEC_AS_ROOT chown root:root *.patch   2> /dev/null

# This must be set for the rpm distros useing build_location
#  otherwise, lint checks fail
export BB_ARCHIVEDIR="$build_location/builder/built-packages"

bb_lint -g prebuild -V $version -R $rev -S ''		|| exit 1
bb_unpack apply						|| exit 1
# flexible_tardir is for packages like nant, boo, etc...
bb_do -V $version -R $rev -S '' -a $BB_ARCHIVEDIR --flexible_tardir 	|| exit 1
bb_lint -V $version -R $rev -S ''			|| exit 1

# Keep copy of the spec file
cp -pf *.spec $build_location/builder/built-packages

rm -rf $BB_ARCHIVEDIR/*.src.rpm

