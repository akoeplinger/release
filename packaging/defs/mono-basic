web_index=8
web_ignore_noarch=1
 
version_selection_reg="1\.\d+"
 
# Note: this noarch package builds on two platforms
#  BE SURE to build on windows first before building the rpm, otherwise the
#  1.0 vb runtime won't be included

BUILD_HOSTS=(
	win-4-i386
        suse-100-i586

	sles-9-x86_64
	sles-9-ia64
	sles-9-ppc
	sles-9-s390
	sles-9-s390x
	macos-10-ppc
	macos-10-x86
	sunos-8-sparc
	sunos-10-x86
	win-4-i386
	debian-31-arm
	debian-31-sparc
)

USE_HOSTS=(
	ALL
)

MONO_DEPS=(
	mono
)

# Put this here since we build on windows
MONO_RECOMMEND_DEPS=(
	libgdiplus
)

get_destroot () {
        if test "x$DISTRO" == "xwin-4-i386" ; then
                DEST_ROOT=$DISTRO
	else
		# noarch for installers
		#DEST_ROOT=noarch
                DEST_ROOT=$DISTRO
	fi
}

HEAD_PATH=(
	trunk/mono-basic
)
RELEASE_PATH=(
	tags/mono-[[version]]/mono-basic
)

update_version_file () {
	sed -i "s/VERSION=\([\.0-9]*\)/VERSION=$VERSION/" configure
}

make_dist () {
	./configure --prefix=/usr

	# should this be needed?
	make

	make dist
}

ZIP_BUILD () {

        # This is so we can use the relocated mono (Will probably have to do this for all builds on mac)
        MONO_GAC_PREFIX=/tmp/build_deps
        MONO_PREFIX=/tmp/build_deps
        MONO_CFG_DIR=/tmp/build_deps/etc
        MONO_PATH=/tmp/build_deps/lib

	# For solaris10 (install)
	PATH=$PATH:/usr/sbin
	export MONO_GAC_PREFIX MONO_PREFIX MONO_CFG_DIR MONO_PATH PATH

	./configure --prefix=/usr
	$make_path

	$make_path install DESTDIR=/tmp/install
}

win_4_i386_ZIP_BUILD () {

	cd vbruntime

	# This doesn't get included with the tarball... create here
	mkdir bin

	OLDPATH=$PATH

	# compiler croaks if this isn't here...
	# Not needed anymore
	#mkdir bin

	########################## 1.0 build #################################
        CSC=`cygpath -d /cygdrive/c/WINDOWS/Microsoft.NET/Framework/v1.1.4322`
        CSC=`cygpath -a $CSC`

        # Add MS SDK to path for ilasm and ildasm
        SDK=`cygpath -d "/cygdrive/c/Program Files/Microsoft.NET/SDK/v1.1/Bin"`
        SDK=`cygpath -a $SDK`
        export PATH=$SDK:$CSC:$OLDPATH

	rm -f Microsoft.VisualBasic.dll Microsoft.VisualBasic/*.log
	cmd /c VB.build.bat 1 release || (cat Microsoft.VisualBasic/*.log && exit 1)

	# Install
	export PATH=$OLDPATH
	cd bin
	/tmp/build_deps/bin/gacutil -package 1.0 -i Microsoft.VisualBasic.dll -root `cygpath -m /tmp/install/lib` || exit 1
	cd ..

	########################## 2.0 build #################################
        CSC=`cygpath -d /cygdrive/c/WINDOWS/Microsoft.NET/Framework/v2.0.50727`
        CSC=`cygpath -a $CSC`

        # Add MS SDK to path for ilasm and ildasm
        SDK=`cygpath -d "/cygdrive/c/Program Files/Microsoft.NET/SDK/v2.0/Bin"`
        SDK=`cygpath -a $SDK`
        export PATH=$SDK:$CSC:$OLDPATH

	rm -f Microsoft.VisualBasic.dll Microsoft.VisualBasic/*.log
	cmd /c VB.build.bat 2 release || (cat Microsoft.VisualBasic/*.log && exit 1)

	# Install
	export PATH=$OLDPATH
	cd bin
	/tmp/build_deps/bin/gacutil -package 2.0 -i Microsoft.VisualBasic.dll -root `cygpath -m /tmp/install/lib` || exit 1
	cd ..

}

POSTBUILD_STEP_NAME1="test"
POSTBUILD_STEP1 () {
	# Not ready to test on windows yet...
        if test "x$DISTRO" == "xwin-4-i386" ; then
                true
        else
		$make_path test
	fi
}

