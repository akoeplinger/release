#!/bin/sh

msvn_tar () {
    get_svn_path
    scp do-msvn-tar $target_host:$jaildir/tmp
    ./jail-do $distro sh -x /tmp/do-msvn-tar $package $svn_path $snapshot_rev || exit 1
    scp $target_host:$jaildir/tmp/built-tarball/*.tar.gz sources/$real_package 
}

get_svn_path () {
    case "$version" in
	snap )
	    if [ x$snapshot_rev == x ]; then
		echo "You need to specify a revision"
		exit 1
	    fi
	    svn_path=$HEAD_PATH
	    ;;
	*)
	    unset snapshot_version
	    versiondash=${version//\./-}
	    version_match=\\[\\[version\\]\\]
	    versiondot_match=\\[\\[versiondot\\]\\]
	    gtksharp2ver_match=\\[\\[gtksharp2ver\\]\\]
	    svn_path=${RELEASE_PATH//$version_match/${versiondash}}
	    svn_path=${svn_path//$versiondot_match/${version}}
	    svn_path=${svn_path//$gtksharp2ver_match/${version/#2.5/1.9}_${version}}
	    ;;
    esac
}



distro=$1
package=$2
version=$3
snapshot_rev=$4

# Argument checking
if [ -z $distro ] || [ -z $package ] || [ -z $version ]; then
	echo ""
	echo "Usage: mktarball <target jail> <package> <version|snap> [svn rev]"
	echo " where version is a tagged version from svn"
	echo " Note: if you specify snap, you must specify svn rev"
	echo ""
	exit 1
fi

real_package=$package

#
# Total hack for the wacked out gtk# stuff
#
if [[ $package = "gtk-sharp-2.6" ]]; then
	real_package="gtk-sharp-2.0"
fi

if [[ $package = "gtk-sharp-2.0" ]]; then
	# Hack to get stuff from the right path
	version=${version/#1.9/2.5}
fi

. shared-code.sh
. conf/$distro
. defs/$real_package

mkdir -p sources/$real_package


if [ ! ${#MONO_DEPS[@]} -eq 0 ]; then
	if ! ./install-deps $distro ${MONO_DEPS[@]}; then
		echo Dependency installation failed, see log in $LOGFILE for details
		exit 1
	fi
fi

if ! get_tarball ; then 
	echo Tarball creation failed
	exit 1
fi
