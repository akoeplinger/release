#!/bin/sh

msvn_tar () {
    get_svn_path
    scp do-msvn-tar $target_host:$jaildir/tmp
    ./jail-do $distro sh -x /tmp/do-msvn-tar $package $svn_path $snapshot_rev || exit 1
    scp $target_host:$jaildir/tmp/built-tarball/*.tar.gz sources/$package 
}

get_svn_path () {
    case "$version" in
	snap )
	    if [ x$snapshot_rev == x ] then;
		echo "You need to specify a revision"
		exit 1
	    fi
	    svn_path=$HEAD_PATH
	    ;;
	*)
	    unset snapshot_version
	    versiondash=${version//\\./-}
	    svn_path=${RELEASE_PATH//\\[\\[version\\]\\]/${versiondash}}
	    svn_path=${svn_path//\\[\\[versiondot\\]\\]/${version}}
	    ;;
    esac
}



distro=$1
package=$2
version=$3
snapshot_rev=$4

. shared-code.sh
. conf/$distro
. defs/$package

mkdir -p sources/$package


if [ ! ${#MONO_DEPS[@]} -eq 0 ]; then
	if ! ./install-deps $distro ${MONO_DEPS[@]}; then
		echo Dependency installation failed, see log in $LOGFILE for details
		exit 1
	fi
fi

if ! get_tarball ; then 
	echo Tarball creation failed
	exit 1
fi
