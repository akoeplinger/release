#!/usr/bin/env python

# TODO: Catch sigint, and unlock jail...

import os
import sys
import distutils.dir_util
import glob
import commands

import pdb

sys.path += ['../pyutils' ]
import logger
import packaging
import utils
import datastore
import config

def usage():
	print ""
	print "Usage: ./mktarball <package> <version|snap> [svn rev]"
	print " where version is a tagged version from svn"
	print " Note: if you specify snap, you must specify svn rev"
	print ""


### Command line arg handling ###
if len(sys.argv) < 3:
	usage()
	sys.exit(1)

package=sys.argv[1]
if sys.argv[2] == "snap":
	try:
		version = sys.argv[3]
	except IndexError:
		usage()
		sys.exit(1)
	RELEASE_or_HEAD = "HEAD"
	source_path = "snapshot_sources"
else:
	version=sys.argv[2]
	RELEASE_or_HEAD = "RELEASE"
	source_path = "sources"


### End of Command line arg handling ###

repo = datastore.source_file_repo()

# Check to see if this is already there
if repo.contains(RELEASE_or_HEAD, package, version):
	print "Source file for %s version %s (%s) exists" % (package, version, RELEASE_or_HEAD) 
	sys.exit(1)

LOGFILE = "%s/%s/%s/%s.log" % (config.mktarball_logs, RELEASE_or_HEAD, package, version)
log_obj = logger.Logger(filename=LOGFILE)
log_obj.log("Sources path: %s\n" % source_path)

package_path = source_path + os.sep + package
distutils.dir_util.mkpath(package_path)

# Get tarball path from def file
package_obj = packaging.package("", package)
if package_obj.info.has_key('MKTARBALL_HOST'):
	distro = package_obj.info['MKTARBALL_HOST']
else:
	distro = config.mktarball_host
log_obj.log("Using distro: %s\n" % distro)

env = packaging.buildenv(distro, logger=log_obj)

if env.is_locked():
	log_obj.log("%s jail is busy\n" % distro )
	sys.exit(2)

env.lock_env()

package_obj = packaging.package(env, package)

if package_obj.info.has_key('MONO_DEPS'):
	(status, output) = utils.launch_process('./install-deps %s %s' % (distro, package), logger=log_obj)
	if status:
		env.unlock_env()
		log_obj.log("Dependency installation failed\n")
		sys.exit(3)


# Copy some files over and execute!
files_to_copy = [ 'do-msvn-tar', 'defs/%s' % package] + glob.glob('../pyutils/*.py') 
env.ssh.copy_to(files_to_copy, '/tmp', mode='scp')

log_obj.log("Starting to build source dist...\n")
(status, output) = env.ssh.execute('mount /proc &> /dev/null', exec_as_root=1)
(status, output) = env.ssh.execute('/tmp/do-msvn-tar %s %s %s' % (RELEASE_or_HEAD, package, version) )

if status:
        env.unlock_env()
        log_obj.log("Source dist file creation failed\n")
        sys.exit(1)

# get tarball filename
tarball = output.split().pop()

# Copy file back
#  Note: the tarball var is expected to have be in this format, ex:  mono-1.1/mono-1.1.13.4.tar.gz
env.ssh.copy_from('/tmp/built-tarball/%s' % tarball, package_path )

# Keep a map of which params produce which tarball
repo.add_file(RELEASE_or_HEAD, package, version, package_path + os.sep + tarball)

env.unlock_env()

print "Done!"

