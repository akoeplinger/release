#!/bin/sh
#
# The driver script to make a tarball
#

package=$1
svn_path=$2
snapshot_rev=$3

cd /tmp
rm -rf tarball-creation
mkdir -p tarball-creation
cd tarball-creation

# use the key in /usr/share/ximian-build-system/conf/ssh
export SVN_SSH=/usr/bin/bb_ssh

if [ ! x$snapshot_rev == x ]; then
	rev_arg="-r $snapshot_rev"
fi

SVNEXPORT="svn export -q $rev_arg"
MONO_ROOT="svn+ssh://distro@mono-cvs.ximian.com/source"
MD_ROOT="svn+ssh://distro@mono-cvs.ximian.com/svn/monodevelop"

#
# These scripts change the version in configure.in to have the svn
# rev number after it.
#
normal_change_ver ()
{
	sed -i "s/\(AM_INIT_AUTOMAKE.*\))/\1.$snapshot_rev)/" configure.in
}

md_change_ver ()
{
	sed -i "s/\(AC_INIT.*\)\(0\.[0-9]*\)/\1\2.$snapshot_rev/" configure.in
}

gtk_sharp_2_4_change_ver ()
{
	sed -i "s/^\(GTK_SHARP_VERSION.*\)$/\1.$snapshot_rev/" bootstrap-2.4
}

gtk_sharp_2_6_change_ver ()
{
	sed -i "s/^\(GTK_SHARP_VERSION.*\)$/\1.$snapshot_rev/" bootstrap-2.6
}

gtk_sharp_2_8_change_ver ()
{
	sed -i "s/^\(GTK_SHARP_VERSION.*\)$/\1.$snapshot_rev/" bootstrap-2.8
}

#
# What to do for autogen...
#

normal_autogen ()
{
	./autogen.sh
}

gtk_sharp_2_4_autogen ()
{
	./bootstrap-2.4
}


gtk_sharp_2_6_autogen ()
{
	./bootstrap-2.6
}

gtk_sharp_2_8_autogen ()
{
	./bootstrap-2.8
}

DO_CHANGE_AUTOMAKE='normal_change_ver'
DO_AUTOGEN='normal_autogen'

# Special case package configurations
case $package in
    mono-1.1 | mono-ifzen )
	# we need to check out both mono and mcs in this case. The svn path we
	# get is just below where the modules live.
	
	$SVNEXPORT $MONO_ROOT/$svn_path/mono
	$SVNEXPORT $MONO_ROOT/$svn_path/mcs
	
	BUILD_DIR=mono
	
	# needed so that we don't need to build the mono in the tarball
	DIST_FLAGS="MCS=mcs RESGEN=resgen"
	
	;;

    monodoc )
	$SVNEXPORT $MONO_ROOT/$svn_path

	# Checkout errors from the mcs module
	mcs_svn_path=${svn_path//monodoc/mono}
	mkdir mcs
	cd mcs
	$SVNEXPORT $MONO_ROOT/$mcs_svn_path/mcs/errors
	cd ..
	
	;;

    monodevelop )
	# md has its own svn repo
	#$SVNEXPORT $MD_ROOT/$svn_path
	$SVNEXPORT $MONO_ROOT/$svn_path
	
	DO_CHANGE_AUTOMAKE='md_change_ver'
	
	;;
	
    gtk-sharp-2.0 )
	DO_CHANGE_AUTOMAKE='gtk_sharp_2_4_change_ver'
	DO_AUTOGEN="gtk_sharp_2_4_autogen"
	
	$SVNEXPORT $MONO_ROOT/$svn_path
        ;;

    gtk-sharp-2.6 )
	DO_CHANGE_AUTOMAKE='gtk_sharp_2_6_change_ver'
	DO_AUTOGEN="gtk_sharp_2_6_autogen"
	
	$SVNEXPORT $MONO_ROOT/$svn_path
        ;;

    gtk-sharp-2.8 )
	DO_CHANGE_AUTOMAKE='gtk_sharp_2_8_change_ver'
	DO_AUTOGEN="gtk_sharp_2_8_autogen"
	
	$SVNEXPORT $MONO_ROOT/$svn_path
        ;;

    * )
	$SVNEXPORT $MONO_ROOT/$svn_path
	;;
esac

: ${BUILD_DIR=$(basename $svn_path)}

cd $BUILD_DIR

if [ ! x$snapshot_rev == x ]; then
	$DO_CHANGE_AUTOMAKE
fi

# SuSE 9.3 gnome pkgconfig path
export PKG_CONFIG_PATH=/opt/gnome/lib/pkgconfig
$DO_AUTOGEN || exit 1
make dist $DIST_FLAGS || exit 1
rm -rf /tmp/built-tarball
mkdir -p /tmp/built-tarball
mv *.tar.gz /tmp/built-tarball

cd /tmp

rm -rf tarball-creation
