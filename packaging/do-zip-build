#!/usr/bin/env bash

rev=$1
package=$2
distro=$3

rm -rf /tmp/builder/built-packages 	|| exit 1
cd /tmp && rm -rf scratch 		|| exit 1
rm -rf install 			 	|| exit 1
mkdir scratch && cd scratch 		|| exit 1

mv ../$package .
mv ../*.tar.gz .
mv ../*.patch .

tarball=`ls *.tar.gz`
component_name_ver=${tarball//\.tar\.gz/}
arch=${distro#*-*-}

if [ -e /usr/local/bin/tar ] ; then
	# This is for the solaris 8 machine
	TAR=/usr/local/bin/tar
else
	TAR=tar
fi

$TAR -zxf *.tar.gz			|| exit 1

# Why wasn't this used? failed unpacking??
#gzip -dc *.tar.gz | tar -xf -		|| exit 1

cd $component_name_ver

# Apply patches
for i in `ls  ../*.patch | sort -n` ; do
	patch -p1 < $i			|| exit 1
done

# Load environment for deps
. /tmp/build_deps/env.sh

# Call the function for this destroot
. /tmp/scratch/$package
DISTRO_UNDERSCORES=${distro//-/_}
${DISTRO_UNDERSCORES}_ZIP_BUILD || exit 1
# TODO:  For some reason the above exit isn't being called on failures

# Package up the build
mkdir -p /tmp/builder/built-packages
cd /tmp/install || exit 1
zip -r /tmp/builder/built-packages/$component_name_ver-$rev.$arch.zip *


