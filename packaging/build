#!/bin/sh
#
# Usage: build [os-target] [package]
#
# Where:
#    os-target is the OS target that we are building for
#    package is the name of the BB XML configuration file on the repository
#
# Example:
#    build suse-92-i386 mono-1.1
#
#

usage()
{
	echo "Usage is: build configuration package"
}

if test x$2 = x; then
    usage
    exit 1;
fi

if test -f status/$1; then
   echo There is already a build in progress on $1
   exit 1
fi

. conf/$1
package=$2

scp do-build $target_host:$jaildir/tmp >& logs/$1
remote_cmd="$chroot /jails/suse-92-i586-root-0/jail sh -x /tmp/do-build $package"
(echo > status/$1; ssh $target_host "sudo $remote_cmd" >& logs/$1; rm status/$1)
scp $target_host:/tmp/status /tmp/status-$1-$2
if grep -q failure /tmp/status-$1-$2; then
   echo Build failed, see log in logs/$1 for details
   exit 1;
fi

mkdir -p packages/$1/$2
scp $target_host:/tmp/root/built-packages/* packages/$1/$2
