#!/bin/bash -x
set -e

BUNDLE="PRE-RELEASE"
STAGE_DIR="$(pwd)/stage/preview"

TARGET_USER="mono-web"
TARGET_HOST="mono.ximian.com"
TARGET_DIR="~/release/monobuild/www/preview"

## For publishing to a local lan in Provo
TARGET_USER="root"
TARGET_HOST="c100.mono.lab.novell.com"
TARGET_DIR="/share/sw/mono-project.org/mono-previews/2.4-rc3.1"

mkdir -p $STAGE_DIR

# Build up stage
cd ../website
cp packaging.css $STAGE_DIR

./sync-bundle.py --skip_missing $BUNDLE $STAGE_DIR
./mk-sources-index.py           $BUNDLE $STAGE_DIR $STAGE_DIR/sources
./mk-archive-index.py           $BUNDLE $STAGE_DIR

# Publish stage
ssh $TARGET_USER@$TARGET_HOST "mkdir -p $TARGET_DIR"
cd $STAGE_DIR
rsync -avzH --delete . $TARGET_USER@$TARGET_HOST:$TARGET_DIR

# TODO: notify x-m-l by mail

