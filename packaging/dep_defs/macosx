#!/usr/bin/env python

# We support 10.4 and up

# gtk+ build notes:
#
#http://developer.imendio.com/projects/gtk-macosx/build-instructions
#http://developer.imendio.com/svn/gtk-osx-build/gtk-osx.modules


BUILD_HOSTS = ['macos-10-ppc', 'macos-10-x86']

prefix = "/Library/Frameworks/Mono.framework/Versions/Current"

packages = [
	{
		'name': 'pkg-config', 
		#'source': 'http://pkgconfig.freedesktop.org/releases/pkg-config-0.22.tar.gz',
		'source': 'http://pkgconfig.freedesktop.org/releases/pkg-config-0.23.tar.gz',
		'post':"""
			# Configure shell wrapper for pkg-config so it will look for .pc files when installed (#79671)
			cd /tmp/install/bin
			mv pkg-config pkg-config.bin
			cat <<EOF > pkg-config
#!/bin/sh
PKG_CONFIG_PATH=/tmp/install/lib/pkgconfig:/tmp/install/share/pkgconfig:\$PKG_CONFIG_PATH /tmp/install/bin/pkg-config.bin "\$@"
EOF
			chmod 755 pkg-config
			"""
	},
	{
		'name': 'gettext', 
		#'source': 'http://ftp.gnu.org/pub/gnu/gettext/gettext-0.16.1.tar.gz',
		'source': 'http://ftp.gnu.org/pub/gnu/gettext/gettext-0.17.tar.gz',
		'post':"""
			# Save msgfmt, as this is needed for building glib
			#  we also need msgmerge for intltool... (monodevelop)
			rm -Rf /tmp/temp_install
			mkdir -p /tmp/temp_install/bin
			cd /tmp/install/bin
			mv msgfmt msgmerge /tmp/temp_install/bin
			cd -

			rm -Rf /tmp/install/bin/*
			rm -Rf /tmp/install/share/doc
			rm -Rf /tmp/install/share/emacs
			rm -Rf /tmp/install/share/gettext

			mv /tmp/temp_install/bin/* /tmp/install/bin
			"""
	},
	{
		'name': 'glib', 
		'source': 'http://ftp.gnome.org/pub/gnome/sources/glib/2.21/glib-2.21.5.tar.bz2',
                # 2.18.4 fails to install for now.
		'pre':"""
			sed -i -e "s/\/usr\/local\/share\/:\/usr\/share\//\/usr\/local\/share\/:\/usr\/share\/:\/Library\/Frameworks\/Mono.framework\/Versions\/Current\/share\//g" glib/gutils.c
			# The following is a hack for a gtk bug where 'which' does not act as expected on mac.
			# see http://lists.macosforge.org/pipermail/macports-users/2007-December.txt and search for 'gtkdoc-rebase'
			find . -iname "makefile\.in" | xargs sed -i -e 's@which[[:space:]]*gtkdoc-rebase@/usr/bin/false@'
			""",
		'post':"""
			# glib-mkenums is required for pango, maybe others
			#rm -Rf /tmp/install/bin/*
			"""
	},
	{
		'name': 'jpeg', 
		'version': '6b',
		'source': 'ftp://ftp.uu.net/graphics/jpeg/jpegsrc.v6b.tar.gz',
		'build':
			"""ln -s `which glibtool` ./libtool

			./configure --enable-shared --enable-static --enable-freetype --prefix=/tmp/install
			make || exit 1
			mkdir -p /tmp/install/lib
			mkdir -p /tmp/install/include
			make install-lib || exit 1
			"""
	},
	{
		'name': 'tiff', 
		'source': 'ftp://ftp.remotesensing.org/pub/libtiff/tiff-3.8.2.tar.gz',
		'build':
			"""
			./configure --prefix=/tmp/install --mandir=/tmp/install/share/man \
				--with-jpeg-include-dir=/tmp/build_deps/include --with-jpeg-lib-dir=/tmp/build_deps/lib

			# 3.8.2's libtool didn't like the sysroot for building on 10.3
			rm libtool
			ln -s `which glibtool` ./libtool

			make || exit 1
			cd libtiff
			make install || exit 1
			"""
	},
	{
		'name': 'libpng',
		#'source': 'http://superb-east.dl.sourceforge.net/sourceforge/libpng/libpng-1.2.20.tar.bz2',
		#'source': 'ftp://ftp.simplesystems.org/pub/libpng/png/src/libpng-1.2.32.tar.bz2',
		'source': 'ftp://ftp.simplesystems.org/pub/libpng/png/src/libpng-1.2.35.tar.bz2',
		'post':"""
			rm -Rf /tmp/install/bin/*
			"""
	},
	{
		'name': 'giflib', 
                'source': 'http://internap.dl.sourceforge.net/sourceforge/giflib/giflib-4.1.6.tar.bz2',
		'post':"""
			rm -Rf /tmp/install/bin/*
			"""
	},
#	# Include this because macosx freetype is too old for the new cairo
#	# (Tiger's used to be sufficient, but it looks like the new cairo needs newer than Tiger's)
#	#  Note: we may not even need this if we're dropping support for 10.3
#	{
#		'name': 'freetype', 
#		'source': 'http://download.savannah.gnu.org/releases/freetype/freetype-2.1.10.tar.bz2',
#		'post':"""
#			rm -Rf /tmp/install/bin/*
#			"""
#	},
	# Include our own because 10.4 and 10.5 ppc have differing expat versions
	{
		'name': 'expat', 
		'source': 'http://internap.dl.sourceforge.net/sourceforge/expat/expat-2.0.1.tar.gz',
		'post':"""
			rm -Rf /tmp/install/bin
			rm -Rf /tmp/install/man
			"""
	},
	{
		'name': 'pixman', 
		#'source': 'http://cairographics.org/releases/pixman-0.14.0.tar.gz',
		'source': 'http://cairographics.org/releases/pixman-0.14.0.tar.gz',
	},
	{
		'name': 'cairo', 
		#'source': 'http://cairographics.org/releases/cairo-1.6.4.tar.gz',
		'source': 'http://cairographics.org/releases/cairo-1.8.6.tar.gz',
		'build': """
			PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/X11R6/lib/pkgconfig FONTCONFIG_CFLAGS=" -I /usr/X11R6/include " FONTCONFIG_LDFLAGS=" -lfontconfig " ./configure --prefix=/tmp/install --enable-quartz --enable-atsui --enable-pdf --disable-xlib
			make
			make install

			# This file doesn't get copied because of a bug (filed and fixed upstream).  Copy manually.
			cp src/cairo-quartz-font.pc /tmp/install/lib/pkgconfig || exit 1
			""",
	},
	#  TODO: There are problems relocating these binaries... is the max header flag not getting passed in?
	#  Hrm... the flag is getting set... which binary is failing?
	{
		'name': 'pango', 
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/pango/1.20/pango-1.20.2.tar.bz2',
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/pango/1.20/pango-1.20.5.tar.bz2',
		'source': 'http://ftp.gnome.org/pub/GNOME/sources/pango/1.22/pango-1.22.4.tar.bz2',
		'build': """

			# Hrm... LDFLAGS not getting set for atsui basic... for it (TODO: file bug)
			sed -e "s/framework Carbon/framework Carbon -headerpad_max_install_names/g" modules/basic/Makefile.in > new
			mv new modules/basic/Makefile.in

			# Use this prefix so we don't have to do any tricks to relocate (Do this with all modules?)
			PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/X11R6/lib/pkgconfig PATH=$PATH:/usr/X11R6/bin ./configure --prefix=%s --without-x
			make

			rm -Rf /tmp/temp_install
			make install DESTDIR=/tmp/temp_install

			# Do this so all the zip files have the same base, and we can lay them back here later
			mkdir -p /tmp/install
			cd /tmp/temp_install%s || exit 1
			mv * /tmp/install
			""" % (prefix, prefix),
	},
	{
		'name': 'atk', 
		#'source': 'http://ftp.gnome.org/pub/gnome/sources/atk/1.20/atk-1.20.0.tar.bz2',
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/atk/1.23/atk-1.23.5.tar.bz2',
		'source': 'http://ftp.gnome.org/pub/GNOME/sources/atk/1.24/atk-1.24.0.tar.bz2',
	},
#	## Tarball generated on linux (opensuse 10.3) using:
#	# Applied patch: http://people.imendio.com/richard/patches/gtk-configure.patch
#	# Applied patch: from Geoff to remove some spew
#	./autogen.sh  --enable-gtk-doc
#	make
#	#  had to remove gtk/test from 'configure' script and from gtk/Makefile.am SUBDIRS ... why wasn't that in the tarball?
#	make dist-bzip2
	{
		# Requires 10.4 or above
		'name': 'gtk+', 
		'version': '2.14.7', 
		#'source': 'http://primates.ximian.com/~wberrier/macos/sources/gtk+-2.15.0.tar.bz2',
		#'source': 'http://ftp.gnome.org/pub/gnome/sources/gtk+/2.14/gtk+-2.14.3.tar.bz2',
		'source': 'http://ftp.gnome.org/pub/gnome/sources/gtk+/2.14/gtk+-2.14.7.tar.bz2',
		'build': """
			# The following is a hack for a gtk bug where 'which' does not act as expected on mac.
                        # see http://lists.macosforge.org/pipermail/macports-users/2007-December.txt and search for 'gtkdoc-rebase'
			find . -iname "makefile\.in" | xargs sed -i -e 's@which[[:space:]]*gtkdoc-rebase@/usr/bin/false@'
                        LDFLAGS="-framework Foundation -framework Carbon -framework AppKit -Xlinker -headerpad_max_install_names" ./configure --prefix=%s --with-gdktarget=quartz --disable-gtk-doc --with-libjpeg --without-libjasper
			make
			cd gtk/xdgmime
			make
			cd -
			make
			cp /usr/share/automake-*/mkinstalldirs .
			make install DESTDIR=/tmp/temp_install

			# Do this so all the zip files have the same base, and we can lay them back here later
			mkdir -p /tmp/install
			cd /tmp/temp_install%s || exit 1
			mv * /tmp/install
			""" % (prefix, prefix),
	},
	{
		'name': 'libglade', 
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/libglade/2.6/libglade-2.6.2.tar.bz2',
		'source': 'http://ftp.gnome.org/pub/GNOME/sources/libglade/2.6/libglade-2.6.3.tar.bz2',
		'build':"""
			export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/lib/pkgconfig
			./configure --prefix=/tmp/install
			make
			make install
		"""
	},
	{
		'name': 'XML-Parser', 
		'source': 'http://search.cpan.org/CPAN/authors/id/M/MS/MSERGEANT/XML-Parser-2.36.tar.gz',
		'build':"""
			perl Makefile.PL PREFIX=/tmp/install EXPATLIBPATH=/usr/X11R6/lib EXPATINCPATH=/usr/X11R6/include
			make
			make install
		"""
	},
	{
		'name': 'XML-Simple', 
		'source': 'http://search.cpan.org/CPAN/authors/id/G/GR/GRANTM/XML-Simple-2.18.tar.gz',
		'build':"""
			perl Makefile.PL PREFIX=/tmp/install
			make
			make install
		"""
	},
        {
		# Required by gtksourceview-2.4.2
                'name': 'intltool',
                'source': 'http://ftp.gnome.org/pub/gnome/sources/intltool/0.40/intltool-0.40.5.tar.bz2',
		'build':"""
                        ./configure --prefix=/tmp/install
                        make
                        make install
                """

        },
# gtksourceview is not used on the mac anymore for mono stuff
	{
		'name': 'gtksourceview',
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/gtksourceview/2.0/gtksourceview-2.0.2.tar.bz2',
		'source': 'http://ftp.acc.umu.se/pub/GNOME/sources/gtksourceview/2.4/gtksourceview-2.4.2.tar.bz2',
                'pre':"""
                        # This is a total hack to fake out the check for xgettext.
			# This can be removed once we get xgettext compiling on mac
                        echo -e '#!/bin/sh\necho "(GNU gettext"' > /tmp/build_deps/bin/xgettext
                        chmod 755 /tmp/build_deps/bin/xgettext
                """,
		'build':"""
			# The following is a hack for a gtk bug where 'which' does not act as expected on mac.
                        # see http://lists.macosforge.org/pipermail/macports-users/2007-December.txt and search for 'gtkdoc-rebase'
			find . -iname "makefile\.in" | xargs sed -i -e 's@which[[:space:]]*gtkdoc-rebase@/usr/bin/false@'
			# We have a libxml-2.0.pc file... even though mac doesn't ship with pkg-config :)
			export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/lib/pkgconfig
			./configure --prefix=/tmp/install --disable-nls --disable-gtk-doc 
			make
			make install
		"""
	},
#	# Dah... this isn't needed for gtk#... it's in gnome#.
#	{
#		'name': 'librsvg', 
#		'source': 'http://ftp.gnome.org/pub/GNOME/sources/librsvg/2.18/librsvg-2.18.2.tar.bz2',
#		'build':"""
#			# fake freetype2.pc files for Apple's libs
#			cat <<EOF > /tmp/build_deps/lib/pkgconfig/freetype2.pc
#prefix=/usr/X11R6
#exec_prefix=\${prefix}
#libdir=/usr/X11R6/lib
#includedir=\${prefix}/include
#
#Name: FreeType 2
#Description: A free, high-quality, and portable font engine.
#Version: 9.16.3
#Requires:
#Libs: -L\${libdir} -lfreetype -lz 
#Cflags: -I\${includedir}/freetype2 -I\${includedir}
#EOF
#			export PKG_CONFIG_PATH=$PKG_CONFIG_PATH:/usr/X11R6/lib/pkgconfig:/usr/lib/pkgconfig
#			./configure --prefix=/tmp/install
#			make
#			make install
#
#		"""
#	},
	#################
	# Theme stuff
	#################
	{
		'name': 'hicolor-icon-theme',
		'source': 'http://icon-theme.freedesktop.org/releases/hicolor-icon-theme-0.10.tar.gz',
	},
	{
		'name': 'icon-naming-utils',
		#'source': 'http://tango.freedesktop.org/releases/icon-naming-utils-0.8.6.tar.gz',
		'source': 'http://tango.freedesktop.org/releases/icon-naming-utils-0.8.7.tar.gz',
	},
	{
		'name': 'gnome-icon-theme',
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/gnome-icon-theme/2.20/gnome-icon-theme-2.20.0.tar.bz2',
		'source': 'http://ftp.gnome.org/pub/GNOME/sources/gnome-icon-theme/2.24/gnome-icon-theme-2.24.0.tar.bz2',
		'pre':"""
			# This is a total hack to fake out the check for xgettext.
                        # This can be removed once we get xgettext compiling on mac
			echo -e '#!/bin/sh\necho "(GNU gettext"' > /tmp/build_deps/bin/xgettext
			chmod 755 /tmp/build_deps/bin/xgettext
		""",
		'build':"""
			export INU_DATA_DIR=/tmp/build_deps/share/icon-naming-utils
			./configure --disable-nls --prefix=/tmp/install --disable-gtk-doc 
			make
			make install
		""",
	},
	{
		'name': 'gtk-engines',
		#'source': 'http://ftp.gnome.org/pub/GNOME/sources/gtk-engines/2.12/gtk-engines-2.12.2.tar.bz2',
		'source': 'http://ftp.gnome.org/pub/GNOME/sources/gtk-engines/2.16/gtk-engines-2.16.1.tar.bz2',
		'pre':"""
                        # This is a total hack to fake out the check for xgettext.
                        # This can be removed once we get xgettext compiling on mac
                        echo -e '#!/bin/sh\necho "(GNU gettext"' > /tmp/build_deps/bin/xgettext
                        chmod 755 /tmp/build_deps/bin/xgettext
                """,
		'build':"""
                        ./configure --disable-nls --prefix=/tmp/install  
                        make
                        make install
                """,
	},
	#####
	#  fontconfig and freetype disabled... enable them?
	{
		'name': 'ImageMagick',
		'version': '6.3.8',
		# Dah, the url keeps getting updated... without saving the old ones.  (Use previous version?)
		#  The source is unmodified, but post a permanent copy
		#'source': 'ftp://ftp.imagemagick.org/pub/ImageMagick/ImageMagick-6.3.8-5.tar.bz2',
		'source': 'http://primates.ximian.com/~wberrier/macos/sources/ImageMagick-6.3.8-11.tar.bz2',
		'build':"""
			./configure --prefix=/tmp/install
			make
			make install SITEPREFIX=/tmp/install
			# Remove docs
			rm -Rf /tmp/install/share/doc/ImageMagick-6.3.8
			#  We don't have to worry too much, because we don't ship ImageMagick
		""",
	},
	#  Ugh... requires imagemagick
	{
		'name': 'tango-icon-theme',
		'source': 'http://tango.freedesktop.org/releases/tango-icon-theme-0.8.1.tar.gz',
		'build':"""
			export MAGICK_CONFIGURE_PATH=/tmp/build_deps/lib/ImageMagick-6.3.8/config
			export MAGICK_CODER_MODULE_PATH=/tmp/build_deps/lib/ImageMagick-6.3.8/modules-Q16/coders
			export INU_DATA_DIR=/tmp/build_deps/share/icon-naming-utils
			./configure --prefix=/tmp/install
			make
			make install
		""",
	},
	{
		'name': 'tango-icon-theme-extras',
		'source': 'http://tango.freedesktop.org/releases/tango-icon-theme-extras-0.1.0.tar.gz',
		'build':"""
			export MAGICK_CONFIGURE_PATH=/tmp/build_deps/lib/ImageMagick-6.3.8/config
			export MAGICK_CODER_MODULE_PATH=/tmp/build_deps/lib/ImageMagick-6.3.8/modules-Q16/coders
			export INU_DATA_DIR=/tmp/build_deps/share/icon-naming-utils
			./configure --prefix=/tmp/install
			make
			make install
		""",
	},
	{
		'name': 'ige-mac-integration',
		'source': 'http://ftp.imendio.com/pub/imendio/ige-mac-integration/ige-mac-integration-0.8.2.tar.gz',
		'build':"""
			LDFLAGS="-framework AppKit -Xlinker -headerpad_max_install_names"  ./configure --prefix=/tmp/install
			make
			make install
		""",
	},
	{
		'name': 'sqlite',
		#'source': 'http://www.sqlite.org/sqlite-3.5.7.tar.gz',
		'source': 'http://www.sqlite.org/sqlite-3.6.10.tar.gz',
		'build':"""
			./configure --prefix=/tmp/install --disable-tcl
			make
			make install
		""",
		'post':"""
			rm -Rf /tmp/install/bin
			rm -Rf /tmp/install/man
			"""
	},



]

